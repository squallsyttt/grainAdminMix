# 微信小程序登录接口说明

## 概述

原生 PHP 实现，不依赖第三方库。**推荐使用手机号授权登录**。

## 核心流程

```text
小程序端同时获取两个 code
  → wx.login() 获取 jsCode（换 openid）
  → getPhoneNumber 获取 phone_code（换手机号）
  → 发送到后端接口
  → 后端根据手机号自动注册/登录
  → 绑定 openid 和用户记录
  → 返回 token
```

---

## 配置

编辑 `application/extra/wechat_miniprogram.php`：

```php
return [
    'app_id' => 'wx1234567890abcdef',     // 从微信公众平台获取
    'app_secret' => 'your_app_secret',    // 从微信公众平台获取
    'session_expire' => 7776000,          // 90天
];
```

或使用环境变量（`.env`）：

```ini
WECHAT_MINIPROGRAM_APPID=wx1234567890abcdef
WECHAT_MINIPROGRAM_SECRET=your_app_secret_here
```

---

## API 接口

### 手机号授权登录（推荐）

**接口地址：** `POST /api/mini-program-auth/login-by-phone`

**适用场景：** 用户授权手机号后自动登录/注册

**请求参数（✅ 推荐方式）：**

| 参数 | 类型 | 必填 | 说明 |
|-----|------|------|------|
| code | string | 是 | wx.login() 返回的 code（用于获取 openid） |
| phone_code | string | 是 | getPhoneNumber 事件返回的 code（一次性） |

**请求参数（兼容旧方式）：**

| 参数 | 类型 | 必填 | 说明 |
|-----|------|------|------|
| code | string | 是 | wx.login() 返回的 code |
| encryptedData | string | 是 | 加密的手机号数据 |
| iv | string | 是 | 加密算法初始向量 |

**返回结果：**

```json
{
  "code": 1,
  "msg": "登录成功",
  "data": {
    "userinfo": {
      "id": 123,
      "mobile": "13800138000",
      "nickname": "用户昵称",
      "token": "登录token"
    }
  }
}
```

**前端完整示例：**

```javascript
// wxml
<button open-type="getPhoneNumber" bindgetphonenumber="handleLogin">
  手机号授权登录
</button>

// js
handleLogin(e) {
  if (!e.detail.code) {
    wx.showToast({ title: '授权失败', icon: 'none' });
    return;
  }

  // 同时获取 jsCode 和 phone_code
  wx.login({
    success: (res) => {
      wx.request({
        url: 'https://your-domain.com/api/mini-program-auth/login-by-phone',
        method: 'POST',
        data: {
          code: res.code,              // wx.login() 的 code
          phone_code: e.detail.code    // getPhoneNumber 的 code
        },
        success: (resp) => {
          if (resp.data.code === 1) {
            // 保存登录信息
            const userinfo = resp.data.data.userinfo;
            wx.setStorageSync('token', userinfo.token);
            wx.setStorageSync('userinfo', userinfo);

            wx.showToast({ title: '登录成功', icon: 'success' });

            // 跳转首页
            setTimeout(() => {
              wx.switchTab({ url: '/pages/index/index' });
            }, 1500);
          } else {
            wx.showToast({ title: resp.data.msg || '登录失败', icon: 'none' });
          }
        },
        fail: (err) => {
          console.error('请求失败', err);
          wx.showToast({ title: '网络错误', icon: 'none' });
        }
      });
    },
    fail: () => {
      wx.showToast({ title: '获取登录凭证失败', icon: 'none' });
    }
  });
}
```

---

## 数据库

**表名：** `grain_wanlshop_third`

| 字段 | 说明 |
|-----|------|
| user_id | 绑定的用户 ID（0=未绑定） |
| platform | 平台标识（`miniprogram`） |
| openid | 微信 openid |
| unionid | 微信 unionid（可选，需绑定开放平台） |
| access_token | 存储 session_key（⚠️ 不下发前端） |
| logintime | 登录时间 |
| expiretime | 到期时间（默认 90 天） |

---

## 安全注意事项

1. ⚠️ **session_key 严禁下发到小程序端**，仅服务器保存
2. ⚠️ **AppSecret 不得提交到代码仓库**，使用环境变量
3. ⚠️ **code 一次性使用**，每次请求前调用 wx.login() 获取新 code
4. ✅ 生产环境使用 HTTPS
5. ✅ 推荐使用 `phone_code` 新方式，更安全

---

## 常见问题

**Q1: code 已被使用（错误码 40163）**

原因：code 只能使用一次
解决：每次调用接口前重新 wx.login()

**Q2: 如何获取 unionid？**

条件：小程序绑定到微信开放平台
用途：统一多个应用的用户身份

**Q3: session_key 何时失效？**

- 长时间未使用（约 90 天）
- 更换设备
- 删除小程序后重新添加

---

## 其他接口（可选）

### 静默登录（不推荐）

**接口地址：** `POST /api/mini-program-auth/login`

适用场景：不需要手机号权限的场景（需手动完善用户信息）

### 完善用户信息

**接口地址：** `POST /api/mini-program-auth/register`

适用场景：静默登录后补充昵称、头像等信息

---

**关键文件：**

- 控制器：`application/api/controller/MiniProgramAuth.php`
- 微信接口封装：`application/common/library/WechatMiniProgram.php`
- 配置文件：`application/extra/wechat_miniprogram.php`

**最后更新：** 2025-10-28 (推荐使用手机号授权登录)
