# 微信小程序登录接口说明

## 概述

本系统实现了完整的微信小程序登录功能，遵循微信官方登录流程，**不依赖任何第三方库（如EasyWeChat）**，采用原生PHP实现。

## 登录流程

```
┌─────────────┐         ┌─────────────┐         ┌─────────────┐
│  小程序端    │         │  开发者服务器 │         │ 微信接口服务 │
│ MiniProgram │         │ Developer   │         │ Wechat API  │
└─────────────┘         └─────────────┘         └─────────────┘
       │                       │                       │
       │ wx.login()获取code     │                       │
       │◄─────────────────────│                       │
       │                       │                       │
       │ wx.request()发送code   │                       │
       ├──────────────────────►│                       │
       │                       │ code2Session接口       │
       │                       ├──────────────────────►│
       │                       │ (appid+secret+code)   │
       │                       │                       │
       │                       │ session_key+openid等   │
       │                       │◄──────────────────────┤
       │                       │                       │
       │                       │ 生成自定义登录态       │
       │                       │ (与openid关联)        │
       │                       │◄─────┐                │
       │                       │      │                │
       │ 返回自定义登录态       │      │                │
       │◄──────────────────────┤      │                │
       │                       │      │                │
       │ 存入storage           │      │                │
       │◄─────┐                │      │                │
       │      │                │      │                │
       │ 后续请求携带登录态     │      │                │
       ├──────────────────────►│      │                │
       │                       │ 验证登录态             │
       │                       │◄─────┘                │
       │ 返回业务数据           │                       │
       │◄──────────────────────┤                       │
```

## 配置说明

### 1. 配置小程序参数

编辑配置文件 `application/extra/wechat_miniprogram.php`：

```php
return [
    // 小程序 AppID（从微信公众平台获取）
    'app_id' => 'wx1234567890abcdef',
    
    // 小程序 AppSecret（从微信公众平台获取）
    'app_secret' => 'your_app_secret_here',
    
    // session_key 有效期（秒）默认90天
    'session_expire' => 7776000,
];
```

**获取 AppID 和 AppSecret：**
1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入【开发】->【开发管理】->【开发设置】
3. 复制 AppID 和 AppSecret

### 2. 配置环境变量（可选）

为了安全，可以使用环境变量配置（推荐生产环境）：

在 `.env` 文件中添加：

```ini
WECHAT_MINIPROGRAM_APPID=wx1234567890abcdef
WECHAT_MINIPROGRAM_SECRET=your_app_secret_here
```

## API接口说明

### 接口 1：静默登录

**接口地址：** `POST /api/mini-program-auth/login`

**接口说明：** 用户首次进入小程序时调用，使用 wx.login() 获取的 code 进行登录。

**请求参数：**

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| code | string | 是 | wx.login() 返回的临时登录凭证 |

**返回结果：**

**情况1：新用户（需要注册）**
```json
{
    "code": 1,
    "msg": "需要完善用户信息",
    "data": {
        "is_new_user": true,
        "need_register": true,
        "third_token": "uuid-string-here"
    }
}
```

**情况2：老用户（直接登录）**
```json
{
    "code": 1,
    "msg": "登录成功",
    "data": {
        "is_new_user": false,
        "need_register": false,
        "userinfo": {
            "id": 123,
            "username": "u_abc123",
            "nickname": "用户昵称",
            "mobile": "13800138000",
            "avatar": "头像URL",
            "token": "登录token"
        }
    }
}
```

**小程序端示例代码：**

```javascript
// 在 app.js 或页面 onLoad 中调用
wx.login({
  success: (res) => {
    if (res.code) {
      // 发送 code 到后端
      wx.request({
        url: 'https://your-domain.com/api/mini-program-auth/login',
        method: 'POST',
        data: {
          code: res.code
        },
        success: (response) => {
          const data = response.data.data;
          
          if (data.need_register) {
            // 新用户，需要跳转到注册页面
            wx.navigateTo({
              url: '/pages/register/index?third_token=' + data.third_token
            });
          } else {
            // 老用户，保存登录信息
            wx.setStorageSync('userinfo', data.userinfo);
            wx.setStorageSync('token', data.userinfo.token);
            
            // 跳转到首页
            wx.switchTab({
              url: '/pages/index/index'
            });
          }
        },
        fail: (error) => {
          console.error('登录失败', error);
          wx.showToast({
            title: '登录失败，请重试',
            icon: 'none'
          });
        }
      });
    }
  }
});
```

---

### 接口 2：手机号授权登录

**接口地址：** `POST /api/mini-program-auth/login-by-phone`

**接口说明：** 用户授权手机号后，使用手机号进行登录/注册。

**请求参数：**

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| code | string | 是 | wx.login() 返回的临时登录凭证 |
| encryptedData | string | 是 | 加密的手机号数据 |
| iv | string | 是 | 加密算法的初始向量 |

**返回结果：**

```json
{
    "code": 1,
    "msg": "登录成功",
    "data": {
        "userinfo": {
            "id": 123,
            "mobile": "13800138000",
            "nickname": "用户昵称",
            "token": "登录token"
        }
    }
}
```

**小程序端示例代码：**

```javascript
// 在 wxml 中添加按钮
<button open-type="getPhoneNumber" bindgetphonenumber="handlePhoneAuth">
  手机号快捷登录
</button>

// 在 js 中处理授权
handlePhoneAuth(e) {
  if (e.detail.errMsg !== 'getPhoneNumber:ok') {
    wx.showToast({
      title: '取消授权',
      icon: 'none'
    });
    return;
  }
  
  // 获取 code
  wx.login({
    success: (res) => {
      // 发送到后端
      wx.request({
        url: 'https://your-domain.com/api/mini-program-auth/login-by-phone',
        method: 'POST',
        data: {
          code: res.code,
          encryptedData: e.detail.encryptedData,
          iv: e.detail.iv
        },
        success: (response) => {
          const userinfo = response.data.data.userinfo;
          
          // 保存登录信息
          wx.setStorageSync('userinfo', userinfo);
          wx.setStorageSync('token', userinfo.token);
          
          wx.showToast({
            title: '登录成功',
            icon: 'success'
          });
          
          // 跳转到首页
          wx.switchTab({
            url: '/pages/index/index'
          });
        },
        fail: (error) => {
          console.error('登录失败', error);
        }
      });
    }
  });
}
```

---

### 接口 3：完善用户信息（注册）

**接口地址：** `POST /api/mini-program-auth/register`

**接口说明：** 新用户首次登录后，完善昵称、头像等信息。

**请求参数：**

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| third_token | string | 是 | login接口返回的临时token |
| nickname | string | 否 | 用户昵称 |
| avatar | string | 否 | 用户头像URL |
| gender | int | 否 | 性别：0=未知，1=男，2=女 |

**返回结果：**

```json
{
    "code": 1,
    "msg": "注册成功",
    "data": {
        "userinfo": {
            "id": 123,
            "username": "u_abc123",
            "nickname": "用户昵称",
            "avatar": "头像URL",
            "token": "登录token"
        }
    }
}
```

**小程序端示例代码：**

```javascript
// 在注册页面 pages/register/index.js
Page({
  data: {
    thirdToken: '',
    nickname: '',
    avatar: ''
  },
  
  onLoad(options) {
    this.setData({
      thirdToken: options.third_token
    });
  },
  
  // 获取用户信息授权
  getUserProfile() {
    wx.getUserProfile({
      desc: '用于完善用户资料',
      success: (res) => {
        this.setData({
          nickname: res.userInfo.nickName,
          avatar: res.userInfo.avatarUrl
        });
        
        // 提交注册
        this.submitRegister();
      }
    });
  },
  
  // 提交注册
  submitRegister() {
    wx.request({
      url: 'https://your-domain.com/api/mini-program-auth/register',
      method: 'POST',
      data: {
        third_token: this.data.thirdToken,
        nickname: this.data.nickname,
        avatar: this.data.avatar,
        gender: 0 // 根据实际情况设置
      },
      success: (response) => {
        const userinfo = response.data.data.userinfo;
        
        // 保存登录信息
        wx.setStorageSync('userinfo', userinfo);
        wx.setStorageSync('token', userinfo.token);
        
        wx.showToast({
          title: '注册成功',
          icon: 'success'
        });
        
        // 跳转到首页
        setTimeout(() => {
          wx.switchTab({
            url: '/pages/index/index'
          });
        }, 1500);
      }
    });
  }
});
```

---

## 数据库说明

登录信息存储在 `grain_wanlshop_third` 表中：

| 字段名 | 类型 | 说明 |
|-------|------|------|
| id | int | 主键 |
| user_id | int | 关联的用户ID |
| platform | varchar | 平台标识（miniprogram） |
| openid | varchar | 微信openid |
| unionid | varchar | 微信unionid（可选） |
| access_token | varchar | session_key（不下发到小程序） |
| token | varchar | 临时token（用于新用户注册） |
| expires_in | int | 过期时间（秒） |
| logintime | int | 登录时间 |
| expiretime | int | 到期时间 |

## 安全注意事项

1. **session_key 绝不下发到小程序端**，仅在服务器端保存
2. **AppSecret 必须保密**，不要提交到代码仓库
3. 生产环境建议使用 HTTPS
4. 及时更新过期的 session_key
5. 对敏感操作添加额外的验证机制

## 常见问题

### Q1: code 已被使用（错误码40163）

**原因：** 小程序登录凭证 code 只能使用一次，重复调用会报错。

**解决：** 每次调用登录接口前，都要先调用 `wx.login()` 获取新的 code。

### Q2: 如何获取 unionid？

**条件：** 小程序必须绑定到微信开放平台，才能获取到 unionid。

**说明：** unionid 用于统一微信开放平台下多个应用的用户身份。

### Q3: session_key 什么时候会失效？

**失效条件：**
- 用户长时间未使用小程序（约90天）
- 用户更换设备
- 用户删除小程序后重新添加

**处理：** 接口返回 session_key 失效错误时，引导用户重新登录。

## 后续扩展

可以在此基础上扩展以下功能：

- [ ] 支持微信公众号登录（H5）
- [ ] 支持微信开放平台APP登录
- [ ] 实现多平台账号统一（通过unionid）
- [ ] 添加手机号验证码登录
- [ ] 实现第三方账号绑定/解绑功能

---

**最后更新时间：** 2025-01-15
