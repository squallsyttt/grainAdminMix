# 小程序与支付逻辑梳理（GrainAdminMix）

最后更新：2025-11-04

本文面向后端/前端联调与运维，聚焦“微信小程序登录/取号”和“支付/充值/提现/退款/回调”等关键链路，基于实际代码梳理实现与使用要点，便于排查问题与扩展。

—— 框架：ThinkPHP 5.x + FastAdmin；API 模块：`application/api/controller/wanlshop/`


## 目录

- 小程序相关
  - 配置项与环境
  - 服务类职责（WechatMiniProgram）
  - 小程序登录/取号/注册接口
- 支付相关
  - 支付聚合（WanlPay 适配层）
  - 下单与预支付
  - 回调通知（订单/充值/退款）
  - 钱包：充值/提现/余额流水
  - 订单收货与商家结算
  - 退款（平台/原路退）
- 安全与幂等
- 关键配置与表结构建议
- 调试与常见问题


## 小程序相关

### 配置项与环境

- 配置文件：`application/extra/wechat_miniprogram.php`
  - 读取自 `.env`：`wechat_miniprogram.app_id` / `wechat_miniprogram.app_secret`
  - 建议配置在生产与测试环境的独立 `.env` 段落中（参考 `.env.sample`）。


### 服务类职责（WechatMiniProgram）

- 位置：`application/common/library/WechatMiniProgram.php`
- 关键方法：
  - `code2Session($code)`：调用 `https://api.weixin.qq.com/sns/jscode2session`，换取 `openid` / `session_key` / `unionid`；对微信错误码做消息映射并记录日志。
  - `getAccessToken()`：获取小程序 `access_token`，使用 `think\Cache` 缓存（ttl=微信返回秒数-200）。
  - `getPhoneNumberByCode($phoneCode)`：使用一次性 `phone_code` 调用 `wxa/business/getuserphonenumber` 获取手机号（推荐用法，避免前端解密）。
  - `decryptData($encryptedData, $iv, $sessionKey)`：备用的前端加密数据解密。
  - 内置 `httpGet`/`httpPostJson` 网络方法与 `getErrorMessage` 错误码转义。


### 小程序登录/取号/注册接口

- 控制器：`application/api/controller/MiniProgramAuth.php`

1) 登录（code2Session）
   - 路由（REST 风格，参考框架路由配置）：`POST /api/mini-program-auth/login`
   - 入参：`code`（`wx.login()` 返回）
   - 流程：
     - 后端调用 `WechatMiniProgram::code2Session` 获取 `openid/session_key/unionid`。
     - 在 `wanlshop_third`（模型 `application/api/model/wanlshop/Third.php`）中以 `platform = 'miniprogram'` 关联/创建第三方登录记录；未绑定用户则自动注册并绑定。
     - 生成并返回后端登录态（`$this->auth`），响应包含 `userinfo`、`is_new_user`。

2) 通过手机号登录（推荐）
   - 路由：`POST /api/mini-program-auth/login-by-phone`
   - 入参：`code`（`wx.login()`）+ `phone_code`（`getPhoneNumber` 一次性 code）
   - 流程：
     - 先 `code2Session` 获取 `openid/unionid`；再用 `phone_code` 直取手机号。
     - 按手机号查找/注册用户，绑定/更新第三方记录；直接下发后端登录态与 `userinfo`。

3) 完善资料注册（备选）
   - 路由：`POST /api/mini-program-auth/register`
   - 入参：`third_token`、`nickname`、`avatar`、`gender`
   - 用途：当业务需要“先三方建档，后补全资料”时可用；当前默认登录已自动注册，通常无需单独调用。


## 支付相关

### 支付聚合（WanlPay 适配层）

- 业务入口主要在控制器：
  - `application/api/controller/wanlshop/Pay.php`
  - `application/api/controller/wanlshop/Callback.php`
- 实际三方支付对接通过 `addons\wanlshop\library\WanlPay\WanlPay` 完成（在本仓库未包含该适配层源代码）。
  - 提供的方法（从调用处反推）：`pay()`、`recharge()`、`notify()`、`notify_recharge()`、`notify_refund()`、`money()`、`refund()` 等。
  - 典型支付类型/方式（从常见约定推断，具体以 WanlPay 配置为准）：
    - `type`：`wechat` / `alipay` / `balance` ...
    - `method`：`miniprogram`（JSAPI/小程序）/ `h5` / `app` ...


### 下单与预支付

- 获取支付信息（用于前端确认页）
  - 路由：`POST /api/wanlshop/pay/getPay`
  - 入参：`order_id`（单个）/ `order_type`（默认 `goods`）
  - 出参：`{ id, order_id, order_no, pay_no, price, order_type, token }`
  - 说明：返回 `token = Common::creatToken('orderToken_{userId}')`，后续发起支付需带上，防重复/重放。

- 发起支付
  - 路由：`POST /api/wanlshop/pay/payment`
  - 入参：
    - `order_id`（数组，支持合并支付）
    - `order_type`（如 `goods`）
    - `type`（支付渠道，如 `wechat`/`alipay`/`balance`）
    - `method`（支付方式，如 `miniprogram`/`h5`/`app`）
    - `code`（部分方式需要，如微信 JSAPI 需用 code 换 openid）
    - `token`（上一步下发的 orderToken）
  - 关键校验与副作用：
    - 校验订单归属与状态，防重复支付。
    - 按商品库存策略 `stock=payment` 时，使用 Redis 扣减秒杀库存队列并减 SKU 库存。
    - 调用 `new WanlPay($type, $method, $code)->pay($order_id, $order_type)` 返回前端拉起支付所需参数（如微信小程序的 `wx.requestPayment` 参数）。

> 小程序支付耦合点：前端需先 `wx.login()` 获取 `code`，再调用 `payment` 接口（`type=wechat`,`method=miniprogram`,`code={wxCode}`），后端完成 `openid` 关联并下发预支付参数，前端再执行 `wx.requestPayment`。


### 回调通知（订单/充值/退款）

- 控制器：`application/api/controller/wanlshop/Callback.php`
  - 订单支付回调：`POST /api/wanlshop/callback/notify/{type}`
  - 充值回调：`POST /api/wanlshop/callback/notify_recharge/{type}`
  - 退款回调：`POST /api/wanlshop/callback/notify_refund/{type}`
  - 说明：`{type}` 由支付渠道决定（如 `wechat`/`alipay`），控制器内部 `new WanlPay($type)->notify_*()` 处理签名、幂等与落库，成功时直接回应该渠道要求的字符串（如 `SUCCESS`）。


### 钱包：充值/提现/余额流水

- 充值
  - 路由：`POST /api/wanlshop/pay/recharge`
  - 入参：`money`、`type`、`method`、`code`
  - 逻辑：`WanlPay->recharge($money)` 返回拉起支付参数；回调由 `notify_recharge` 处理入账。

- 提现
  - 获取初始数据：`POST /api/wanlshop/pay/initialWithdraw` → 返回可提现余额、服务费率、最近账户
  - 账户管理：`getPayAccount` / `addPayAccount` / `delPayAccount`
  - 发起提现：`POST /api/wanlshop/pay/withdraw`
    - 校验余额、次数、最小金额与服务费配置（`get_addon_config('wanlshop')`）。
    - 创建提现单后 `WanlPay->money(-$money, $user_id, '申请提现', 'withdraw', $withdrawId)` 记账冻结/扣减。

- 余额流水/详情/余额
  - `moneyLog` / `details` / `getBalance` 提供查询能力（见 `Pay.php`）。


### 订单收货与商家结算

- 控制器：`application/api/controller/wanlshop/Order.php`
  - 买家确认收货后：`WanlPay->money(+价格, shop_user_id, '买家确认收货', 'pay', 订单号)` 向商家划账。
  - 若存在退款记录，会按退款金额先行冲减商家账务。


### 退款（平台/原路退）

- 买家端仅发起/查看，真正退款在后台或平台侧触发。
- 后台控制器：`application/admin/controller/wanlshop/Refund.php`
  - 同意退款：优先退至买家余额；若配置 `refund_switch='Y'` 则调用 `WanlPay->refund(refundId, 金额, order_pay_id)` 走原路退：
    - `code=0` 代表同步确认成功（或可据 `fund_change=Y` 判定）；
    - `code=200` 代表已提交渠道处理，等待异步回调 `notify_refund`；
    - `code=1` 或其他：降级退至余额并提示线下处理。
  - 所有路径均写入退款日志与状态流转，必要时扣减本地余额（原路成功时从余额冲回）。


## 安全与幂等

- 防重放：下单支付使用 `orderToken`（`Common::creatToken/checkToken`）。
- 并发库存：`payment` 时使用 Redis 队列 + 减库存，避免超卖。
- 回调幂等：由 `WanlPay->notify_*()` 内部处理（依赖其实现与本地订单/支付单状态锁）。
- 敏感日志：外部回调失败/异常均写入 `Log`，便于排查。


## 关键配置与表结构建议

- 配置
  - 小程序：`application/extra/wechat_miniprogram.php`（`.env` 提供 `app_id`/`app_secret`）
  - 插件/业务：`get_addon_config('wanlshop')` 控制提现、退款开关与费率等。

- 主要数据表（模型定义于 `application/api/model/wanlshop/`）
  - `wanlshop_pay`：支付单（建议索引：`order_id`、`pay_no`、`user_id`、`status`）
  - `wanlshop_pay_out_trade`：出款合单（建议索引：`order_id`、`pay_id`）
  - `recharge_order`：充值订单（建议索引：`user_id`、`status`、`createtime`）
  - `wanlshop_third`：第三方登录（建议索引：`platform`、`unionid`、`openid`、`user_id`）


## 调试与常见问题（FAQ）

- 小程序登录报错“配置未设置”：检查 `.env` 中 `wechat_miniprogram.app_id/app_secret` 是否就绪，缓存是否过期。
- `getPhoneNumberByCode` 失败：确认前端获取的是一次性 `code`，且服务端 `access_token` 有效。
- 支付无法拉起/预付单为空：
  - 是否传入正确的 `type/method` 与 `code`（微信小程序 JSAPI 需 `code` 获取 `openid`）。
  - 是否通过 `getPay` 拿到并携带了 `orderToken`。
  - 订单状态是否已改变（防重复支付）。
- 回调未触发或渠道回执不正确：核对回调 URL 与 `{type}` 参数，查看 `Callback` 日志与渠道平台配置。
- 退款未原路返回：检查后台 `refund_switch`；若已走余额退，需提示用户提现或人工协助。


## 附：文件索引（便于快速定位）

- 小程序
  - 服务类：`application/common/library/WechatMiniProgram.php`
  - 登录控制器：`application/api/controller/MiniProgramAuth.php`
  - 配置：`application/extra/wechat_miniprogram.php`、`.env.sample`

- 支付
  - 下单/钱包：`application/api/controller/wanlshop/Pay.php`
  - 回调：`application/api/controller/wanlshop/Callback.php`
  - 订单确认收货：`application/api/controller/wanlshop/Order.php`
  - 后台退款：`application/admin/controller/wanlshop/Refund.php`
  - 模型：`application/api/model/wanlshop/Pay.php`、`RechargeOrder.php`、`PayOutTrade.php`、`Third.php`

（说明）本仓库未包含 `WanlPay` 适配层源码，其对接渠道（微信/支付宝等）与签名/通知等细节以该组件实际实现与配置为准。

