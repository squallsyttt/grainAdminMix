# 综合返利管理 - 业务逻辑说明

---

## 一、返利类型概览

系统支持4种返利场景（店铺邀请返利已废弃）：

| 返利类型 | 类型标识 | 返利接收人 | 触发条件 | 状态 |
|---------|---------|-----------|---------|------|
| 核销返利 | `normal` | 购券用户 | 用户到店核销 | ✅ 启用 |
| 代管理返利 | `custody` | 购券用户 | 代管理审核通过 | ✅ 启用 |
| 用户邀请返利 | `user_invite` | 邀请人 | 被邀请人首次核销 | ✅ 启用 |
| BD推广佣金 | `bd_promoter` | BD推广员 | 绑定店铺有核销 | ✅ 启用 |
| ~~店铺邀请返利~~ | `shop_invite` | ~~邀请人~~ | ~~被邀请店铺有核销~~ | ❌ 已废弃（由「加入平台」模块替代） |


---

## 二、核销返利（普通到店核销）

### 业务流程

```
┌─────────────────────────────────────────────────────────────┐
│                        用户购券支付                           │
│              ★ 7天冷静期从此刻开始计时 ★                      │
└──────────────────────────┬──────────────────────────────────┘
                           │
                    （冷静期倒计时中...）
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                   用户到店出示券码                            │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                  商家扫码/输入验证码                          │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                    系统核销成功                              │
│              • 券状态变为「已核销」                           │
│              • 生成返利记录                                   │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│              检查打款条件（两个条件都需满足）                   │
│    ✓ 条件1：已核销（verify_time > 0）                        │
│    ✓ 条件2：支付时间超过7天（payment_time < 当前-7天）         │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                   后台发起返利打款                            │
│              • 打款至用户微信零钱                             │
└─────────────────────────────────────────────────────────────┘
```

> ⚠️ **重要说明**：7天冷静期从**支付时间**开始算，不是从核销时间开始。
> - 如果用户在支付后第3天核销，还需等4天才能打款
> - 如果用户在支付后第10天核销，核销后立即可打款（支付已超7天）

### 返利金额计算规则

**核心公式：** `返利金额 = 券面值 × 实际返利比例`

返利比例会根据「距付款天数」进行阶段衰减：

```
付款日
  │
  ├──────────────┬──────────────┬──────────────┬──────────────
  │   免费期      │  福利损耗期   │  货物损耗期   │   已过期
  │  (30天)      │   (30天)     │   (30天)     │
  │              │              │              │
  │ 返利：100%   │ 返利：逐日递减 │ 返利：0%     │ 返利：0%
  │ 货物：100%   │ 货物：100%    │ 货物：逐日递减 │ 货物：0%
  │              │              │              │
  ▼              ▼              ▼              ▼
第0天          第30天         第60天         第90天
```

### 阶段分类

| 阶段标识 | 阶段名称 | 时间范围 | 返利比例 | 货物重量 |
|---------|---------|---------|---------|---------|
| `free` | 免费期 | 第1-30天 | 用户原始比例（如2%） | 100% |
| `welfare` | 福利损耗期 | 第31-60天 | 每天递减，直到0% | 100% |
| `goods` | 货物损耗期 | 第61-90天 | 0% | 每天递减，直到0% |
| `expired` | 已过期 | 超过90天 | 0% | 0% |

> 注：阶段天数可通过后台「返利规则」配置调整

---

## 三、代管理返利

### 业务场景

用户购券后不想自己到店提货，可申请「平台代管理」，由平台统一处理。

### 业务流程

```
┌─────────────────────────────────────────────────────────────┐
│                     用户申请代管理                            │
│                  券状态变为「申请中」                          │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                    后台审核                                  │
│              • 查看库存对比分析                               │
│              • 评估是否通过                                   │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
              ┌────────────┴────────────┐
              ▼                         ▼
┌─────────────────────┐     ┌─────────────────────────────────┐
│      审核拒绝        │     │           审核通过               │
│  • 用户可继续核销    │     │   • 券状态变为「已核销」          │
│  • 或重新申请        │     │   • 生成代管理返利记录            │
└─────────────────────┘     └──────────────┬──────────────────┘
                                           ▼
                           ┌───────────────────────────────────┐
                           │      同时发起两项返还操作           │
                           ├───────────────┬───────────────────┤
                           ▼               ▼                   │
              ┌─────────────────┐  ┌─────────────────────────┐ │
              │   ① 返利打款     │  │    ② 等量退款            │ │
              │  打款至微信零钱  │  │   原路退回支付金额        │ │
              │  金额=计算后返利  │  │   金额=按阶段计算         │ │
              └─────────────────┘  └─────────────────────────┘ │
                           └───────────────────────────────────┘
```

### 代管理返还金额

**用户最终获得 = 返利金额 + 等量退款**

| 项目 | 计算方式 | 说明 |
|------|---------|------|
| **返利金额** | 券面值 × 实际返利比例 | 按阶段衰减，与普通核销相同算法 |
| **等量退款** | 券面值 × 货物剩余比例 | 免费期/福利损耗期：全额；货物损耗期：按比例；已过期：0 |

**示例（假设用户购买100元的券，返利比例2%，配置30/30/30天）：**

| 申请时机 | 阶段 | 货物剩余 | 返利金额 | 等量退款 | 用户实际获得 |
|---------|------|---------|---------|---------|------------|
| 第15天申请 | 免费期 | 100% | 2元 | 100元 | **102元** |
| 第45天申请 | 福利损耗期 | 100% | 约1元 | 100元 | **约101元** |
| 第75天申请 | 货物损耗期 | 50% | 0元 | **50元** | **50元** |
| 超过90天 | 已过期 | 0% | 0元 | **0元** | **0元** |

> **重点：** 代管理的等量退款在货物损耗期会按货物剩余比例递减，已过期则不退款。返利部分也按阶段衰减。

---

## 四、用户邀请返利

### 业务流程

```
┌─────────────────────────────────────────────────────────────┐
│              老用户查看「我的邀请码」（8位字母数字）               │
│                  分享邀请码给好友                              │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                     新用户登录小程序                          │
│              （微信授权登录，自动注册账号）                     │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│              新用户主动绑定邀请码（前端操作）                    │
│        • 输入8位邀请码                                        │
│        • 系统验证邀请码有效                                    │
│        • 绑定邀请关系（inviter_id + invite_bind_time）        │
│        ⚠️ 每个用户只能绑定一次，绑定后不可更改                    │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                     新用户购券                               │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│               新用户首次到店核销                               │
│        系统自动检查该用户是否有邀请人                            │
│        若有，且该用户未触发过返利入队：                          │
│        → 生成「用户邀请返利待审核」记录                          │
│        → 锁定当时的返利比例和金额                               │
│        → 写入 user_invite_pending 表                         │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                    后台审核（阶段一）                         │
│            • 24小时提示仅供参考，不阻止操作                    │
│            • 检查券是否已退款（硬性条件）                      │
│            • 若已退款，记录自动取消                           │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
              ┌────────────┴────────────┐
              ▼                         ▼
┌─────────────────────┐     ┌─────────────────────────────────┐
│      取消/拒绝       │     │           审核通过               │
│  • 券已退款自动取消   │     │  • 写入 user_invite_rebate_log   │
│  • state=2          │     │  • 写入 voucher_rebate 表        │
└─────────────────────┘     │  • state=1（已处理）              │
                            └──────────────┬──────────────────┘
                                           ▼
                            ┌─────────────────────────────────┐
                            │        后台打款（阶段二）          │
                            │      发起返利打款（微信商家转账）   │
                            │        打款至邀请人微信零钱        │
                            └─────────────────────────────────┘
```

### 关键代码位置

| 功能 | 文件路径 | 方法/行号 |
|------|---------|----------|
| 绑定邀请码接口 | `application/api/controller/MiniProgramAuth.php` | `bindInviteCode()` (行390-461) |
| 核销时触发返利入队 | `application/api/controller/wanlshop/voucher/Verify.php` | `processInviterRebatePending()` (行662-717) |
| 后台待审核列表 | `application/admin/controller/wanlshop/voucher/UserInviteRebate.php` | `pending()` (行36-92) |
| 发放返利操作 | `application/admin/controller/wanlshop/voucher/UserInviteRebate.php` | `grantRebate()` (行100-153) |
| 打款操作 | `application/admin/controller/wanlshop/voucher/UserInviteRebate.php` | `transfer()` (行311-352) |

### 数据表说明

| 表名 | 说明 |
|------|------|
| `grain_user` | 用户表，`inviter_id`=邀请人ID，`invite_bind_time`=绑定时间 |
| `grain_user_invite_pending` | 待审核返利队列，`state`: 0=待审核, 1=已发放, 2=已取消 |
| `grain_user_invite_rebate_log` | 返利发放日志 |
| `grain_wanlshop_voucher_rebate` | 统一返利表（用于打款），`rebate_type`='user_invite' |

### 返利金额计算

**公式：** `返利金额 = 券面值 × 邀请人返利比例`

**特点：**
- 返利比例在新用户核销时锁定，不受后续比例调整影响
- 同一新用户只触发一次邀请返利（首次核销，幂等控制）
- **无阶段衰减**，按锁定时的比例全额计算
- 邀请人等级（bonus_level）影响返利比例，可通过邀请人核销升级

### 邀请人等级与返利比例

邀请人等级配置读取自系统配置：

| 等级 | 配置项 | 说明 |
|------|-------|------|
| Level 0 | `site.invite_base_ratio` | 基础返利比例 |
| Level 1 | `site.invite_level1_ratio` | 1级返利比例（邀请1人核销升级） |
| Level 2 | `site.invite_level2_ratio` | 2级返利比例（邀请2人核销升级，满级） |

---

## 五、店铺邀请返利（淡化）

> **⚠️ 该功能已废弃**
>
> 店铺邀请返利功能已停用，相关逻辑已被「**加入平台**」模块替代。
>
> **替代方案**：店铺入驻流程改为通过「加入平台」模块处理，旧的模式只在审核通过之后升级普通返利等级。
>
> **历史数据**：已有的 `shop_invite` 类型返利记录仍保留在数据库中

<details>
<summary>点击展开历史业务流程（仅供参考）</summary>

### 原业务流程（淡化）

```
┌─────────────────────────────────────────────────────────────┐
│                老用户邀请新店铺入驻                            │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│             新店铺注册并通过审核（绑定邀请关系）                  │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                  新店铺核销用户的券                            │
│        系统自动生成「店铺邀请返利待审核」记录                     │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                 强制等待24小时                                │
│              （防止退款风险，不可跳过）                         │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                    后台审核                                  │
│            • 检查券是否已退款                                  │
│            • 计算邀请人是否升级                                │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
              ┌────────────┴────────────┐
              ▼                         ▼
┌─────────────────────┐     ┌─────────────────────────────────┐
│      取消/拒绝       │     │           审核通过                │
└─────────────────────┘     │     ① 邀请人等级+1（如未满级）     │
                            │     ② 生成正式返利记录            │
                            └──────────────┬──────────────────┘
                                           ▼
                            ┌─────────────────────────────────┐
                            │          发起返利打款             │
                            │        打款至邀请人微信零钱        │
                            └─────────────────────────────────┘
```

### 原返利金额计算（已淡化）

**公式：** `返利金额 = 券面值 × 升级后的返利比例`

### 原邀请人等级体系（已淡化）

| 等级 | 等级值 | 返利比例 | 升级条件 |
|------|-------|---------|---------|
| 基础等级 | 0 | 基础比例 | 默认等级 |
| 1级 | 1 | 提升比例 | 成功邀请1个店铺 |
| 满级 | 2 | 最高比例 | 成功邀请2个店铺 |

</details>

---

## 六、打款状态流转

### 状态分类

| 状态标识 | 状态名称 | 说明 |
|---------|---------|------|
| `unpaid` | 未打款 | 待发起打款 |
| `pending` | 打款中 | 已发起，等待用户确认 |
| `paid` | 已打款 | 打款成功 |
| `failed` | 打款失败 | 可重试 |
| `refunded` | 已退款 | 已退回 |

### 状态流转图

```
                    ┌──────────────┐
                    │    unpaid    │
                    │   (未打款)    │
                    └──────┬───────┘
                           │ 发起打款
                           ▼
                    ┌──────────────┐
         ┌──────────│   pending    │──────────┐
         │          │  (打款中)     │          │
         │          └──────────────┘          │
         │ 打款失败                      用户确认 │
         ▼                                    ▼
  ┌──────────────┐                    ┌──────────────┐
  │    failed    │───── 重试 ────────▶│     paid     │
  │  (打款失败)   │                    │   (已打款)    │
  └──────────────┘                    └──────────────┘
```

---

## 七、各类返利对比总结

### 核心差异对比

| 对比项 | 核销返利 | 代管理返利 | 用户邀请返利 |
|-------|---------|-----------|-------------|
| **类型标识** | `normal` | `custody` | `user_invite` |
| **返利接收人** | 购券用户 | 购券用户 | 邀请人 |
| **触发时机** | 到店核销 | 审核通过 | 被邀请人首次核销 |
| **阶段衰减** | ✅ 有 | ✅ 有 | ❌ 无 |
| **等量退款** | ❌ 无 | ✅ 有（按阶段比例，详见第三段） | ❌ 无 |
| **审核流程** | 需审核（7天冷静期） | 需要审核 | 需要审核 |
| **打款等待期** | 支付后7天 | 无 | 无 |
| **幂等控制** | 每券一次 | 每券一次 | 每个新用户首券一次 |

> **注**：店铺邀请返利（`shop_invite`）已废弃，由「加入平台」模块替代。

### 打款时机对比

```
┌─────────────────────────────────────────────────────────────┐
│                      核销返利 (normal)                       │
│  支付 ──(7天冷静期)──▶ 核销(任意时刻) ──▶ 满足两条件后打款   │
│         ↑                                                    │
│    冷静期从支付开始算                                         │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                     代管理返利 (custody)                     │
│                审核通过 ──────────────────────────────▶ 打款  │
│                        ╲                                    │
│                         ╲───────────────────────────▶ 退款  │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                   用户邀请返利 (user_invite)                 │
│                                                              │
│  被邀请人首次核销                                             │
│       │                                                      │
│       ▼                                                      │
│  写入待审核表 (user_invite_pending)  ← "入队"                │
│  锁定：邀请人ID、返利比例、券面值、核销时间                    │
│       │                                                      │
│       ▼                                                      │
│  后台审核（建议等24h，防止券退款）                             │
│       │                                                      │
│       ├──▶ 通过：写入 voucher_rebate 表，发起打款             │
│       └──▶ 拒绝/券已退款：标记取消                            │
└─────────────────────────────────────────────────────────────┘
```

**术语说明**：
- **入队**：指将返利记录写入 `user_invite_pending` 待审核表，此时返利金额和比例已锁定，等待后台人工审核

---

## 八、常见问题说明

### Q1: 代管理时，用户能拿到多少钱？

**答：** 用户获得 = 返利金额 + 等量退款

| 项目 | 计算方式 | 说明 |
|------|---------|------|
| **返利金额** | 券面值 × 实际返利比例 | 按阶段衰减，免费期100%，福利损耗期递减，货物损耗期为0 |
| **等量退款** | 券面值 × 货物剩余比例 | 免费期/福利损耗期=100%，货物损耗期按天递减，已过期=0 |

**示例**（100元券，30/30/30天配置）：
- 第15天申请（免费期）：返利2元 + 退款100元 = **102元**
- 第45天申请（福利损耗期）：返利约1元 + 退款100元 = **约101元**
- 第75天申请（货物损耗期）：返利0元 + 退款约50元 = **约50元**
- 超90天（已过期）：返利0元 + 退款0元 = **0元**

### Q2: 为什么核销返利要等7天才能打款？

**答：** 7天是冷静期，防止用户核销后立即退款造成平台损失。

**重要：冷静期从支付时间开始算，不是从核销时间开始。** 打款需同时满足两个条件：
1. 券已核销（verify_time > 0）
2. 支付时间超过7天（payment_time < 当前时间 - 7天）

**示例**：
- 用户 Day 0 支付，Day 3 核销 → Day 7 才能打款（再等4天）
- 用户 Day 0 支付，Day 8 核销 → 核销后立即可打款（支付已超7天）

代管理、邀请返利因为有人工审核环节，已经过了风险期，所以无需等待。

### Q3: 邀请返利的比例是什么时候确定的？

**答：**
- **用户邀请返利**：在被邀请人核销时锁定，后续比例调整不影响已入队的记录
- **店铺邀请返利**：已废弃，由「加入平台」模块替代

### Q4: 阶段天数可以调整吗？

**答：** 可以，通过后台「返利规则管理」配置免费期、福利损耗期、货物损耗期的天数。

---

*文档版本：v1.3*
*更新日期：2025-12-29*
*本次更新：修正对比表格（等量退款按阶段比例、核销返利需审核、幂等控制为首券一次），完善「入队」术语说明*
