# 返利逻辑修改记录

---

## ✅ 一、代管理退款逻辑修复（已完成 2025-12-29）

### 问题描述

代管理退款在**货物损耗期**应该按实际货物损耗比例退款，而不是全额退款。

### 修复后的逻辑

- 免费期 + 福利损耗期：退款 = 券面值（全额）
- 货物损耗期：退款 = 券面值 × (实际货物重量 / 原始货物重量)
- 已过期：退款 = 0

### 修改的文件

1. ✅ `application/common/service/VoucherRebateService.php:105-127`
   - 计算等量退款时按阶段判断

2. ✅ `application/admin/service/CustodyRefundService.php:47-54`
   - 使用 `$rebate->refund_amount` 而不是 `$voucher->face_value`

### 示例（假设券面值100元，配置30/30/30天）

| 申请时机 | 阶段 | 货物剩余比例 | 返利金额 | 退款金额 | 用户实际获得 |
|---------|------|------------|---------|---------|------------|
| 第15天 | 免费期 | 100% | 2元 | 100元 | **102元** |
| 第45天 | 福利损耗期 | 100% | ~1元 | 100元 | **~101元** |
| 第75天 | 货物损耗期 | 50% | 0元 | **50元** | **50元** |
| 超过90天 | 已过期 | 0% | 0元 | **0元** | **0元** |

---

## ✅ 二、核销返利7天冷静期（已完成 2025-12-29）

冷静期从**支付时间**开始计算，不是从核销时间开始。

相关代码验证：
- `application/admin/model/wanlshop/VoucherRebate.php:108-110`
- `application/admin/service/RebateTransferService.php:82-85`

---

*更新时间：2025-12-29*
