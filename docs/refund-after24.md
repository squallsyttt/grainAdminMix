  ---
  核销后24小时退款审核功能 - 设计方案

  一、业务流程设计

  ┌─────────────────────────────────────────────────────────────────────────────┐
  │                            现有流程（未使用券）                               │
  │  用户申请 → 系统自动判断(state=1) → 直接进入后台退款列表 → 后台处理            │
  └─────────────────────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────────────────────────┐
  │                        新增流程（已核销24h内）                                │
  │  用户申请(state=2且核销<24h) → 创建退款记录(merchant_audit_state=0)          │
  │       ↓                                                                     │
  │  进入商家待审核队列 → 商家在小程序端审核                                       │
  │       ↓                                                                     │
  │  ┌─ 同意 → merchant_audit_state=1, state=1 → 进入后台退款列表                │
  │  └─ 拒绝 → merchant_audit_state=2, state=2 → 流程结束                        │
  └─────────────────────────────────────────────────────────────────────────────┘

  二、数据库变更

  在 grain_wanlshop_voucher_refund 表新增字段：

  | 字段名                   | 类型           | 说明                                      |
  |-----------------------|--------------|-----------------------------------------|
  | refund_source         | VARCHAR(32)  | 退款来源：unused=未使用退款，verified_24h=核销后24h退款 |
  | merchant_audit_state  | TINYINT(1)   | 商家审核状态：NULL=无需审核，0=待审核，1=已同意，2=已拒绝      |
  | merchant_audit_time   | INT(10)      | 商家审核时间                                  |
  | merchant_audit_remark | VARCHAR(255) | 商家审核备注                                  |
  | shop_id               | INT(10)      | 关联核销店铺ID                                |

  三、接口设计

  3.1 修改现有接口

  POST /api/wanlshop/voucher/refund/apply

  增加对 state=2（已核销）的处理：
  - 检查核销时间是否在24小时内
  - 设置 refund_source='verified_24h'
  - 设置 merchant_audit_state=0（待审核）
  - 记录 shop_id

  3.2 新增接口

  | 接口                                               | 方法   | 说明            |
  |--------------------------------------------------|------|---------------|
  | /api/wanlshop/voucher/refund/merchantPendingList | GET  | 商家获取待审核退款列表   |
  | /api/wanlshop/voucher/refund/merchantAudit       | POST | 商家审核退款（同意/拒绝） |

  四、前端页面变更

  4.1 用户端 - 券详情页

  文件：/grainMpMix/src/pages/voucher/detail/index.tsx

  修改 canRefundVoucher() 函数，增加已核销券的退款判断：
  - state === '2' 且 verifytime 存在
  - 核销时间距今 ≤ 24小时
  - 无待处理退款记录

  按钮文案：「申请退款（需商家同意）」

  4.2 商家端 - 绑定页新增入口

  文件：/grainMpMix/src/pages/merchant/bind/index.tsx

  在"商品管理"下方新增"退款审核"卡片：
  - 显示待审核数量角标
  - 点击跳转审核列表页

  4.3 商家端 - 新增审核列表页

  新建文件：/grainMpMix/src/pages/merchant/refund-audit/index.tsx

  功能：
  - 展示待审核退款列表
  - 显示券信息、核销时间、退款金额
  - 同意/拒绝操作按钮

  五、边界情况处理

  | 场景      | 处理方案                                       |
  |---------|--------------------------------------------|
  | 24小时边界  | 后端增加60秒容差                                  |
  | 商家未及时审核 | MVP不设超时，后续可加48h自动拒绝                        |
  | 重复申请    | 检查 state in [0,1] 或 merchant_audit_state=0 |
  | 退款后结算处理 | 取消对应结算记录，新增状态5=已退款取消                       |

  六、实施步骤

  1. 数据库变更 - 新增字段
  2. 后端接口 - 修改apply，新增商家审核接口
  3. 前端用户端 - 修改券详情页退款逻辑
  4. 前端商家端 - 绑定页入口 + 新建审核页
  5. 测试验证 - 边界场景测试

  ---