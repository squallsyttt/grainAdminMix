<style type="text/css">
	:root {
		--wanl-bg: #f6f7fb;
		--wanl-surface: #ffffff;
		--wanl-border: #e5e7eb;
		--wanl-muted: #6b7280;
		--wanl-strong: #0f172a;
		--wanl-primary: #0ea5e9;
		--wanl-primary-soft: #e0f2fe;
		--wanl-accent: #6366f1;
		--wanl-success: #22c55e;
		--wanl-shadow: 0 18px 38px -24px rgba(15, 23, 42, 0.35);
	}
	.panel-intro {
		background: var(--wanl-bg);
		border: none;
		box-shadow: inset 0 1px 0 rgba(15, 23, 42, 0.04);
	}
	.panel-heading {
		background: transparent;
		border-bottom: 1px solid var(--wanl-border);
		padding: 12px 0 6px;
	}
	.wanl-head {
		display: flex;
		align-items: center;
		justify-content: space-between;
		gap: 12px;
	}
	.wanl-kicker {
		color: var(--wanl-accent);
		font-weight: 700;
		font-size: 12px;
		letter-spacing: 0.02em;
		text-transform: uppercase;
		margin: 0 0 4px;
	}
	.wanl-title {
		margin: 0;
		color: var(--wanl-strong);
		font-weight: 700;
	}
	.wanl-subtitle {
		margin: 4px 0 0;
		color: var(--wanl-muted);
		font-size: 13px;
	}
	.panel-body {
		padding: 6px 0 12px;
	}
	.wanl-stat-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
		gap: 12px;
		margin-bottom: 14px;
	}
	.wanl-stat-card {
		background: var(--wanl-surface);
		border: 1px solid var(--wanl-border);
		border-radius: 14px;
		padding: 14px;
		display: flex;
		align-items: center;
		gap: 12px;
		box-shadow: var(--wanl-shadow);
	}
	.wanl-stat-card .icon {
		width: 48px;
		height: 48px;
		border-radius: 12px;
		display: inline-flex;
		align-items: center;
		justify-content: center;
		color: #fff;
		font-size: 20px;
	}
	.wanl-stat-card .meta {
		line-height: 1.3;
	}
	.wanl-stat-card .value {
		font-size: 22px;
		font-weight: 700;
		color: var(--wanl-strong);
	}
	.wanl-stat-card .label {
		color: var(--wanl-muted);
		font-size: 12px;
	}
	.wanl-filter {
		background: var(--wanl-surface);
		border: 1px dashed rgba(14, 165, 233, 0.35);
		border-radius: 14px;
		padding: 14px 16px;
		box-shadow: var(--wanl-shadow);
		margin-bottom: 14px;
	}
	.wanl-filter form {
		display: flex;
		flex-wrap: wrap;
		gap: 10px;
		align-items: center;
	}
	.wanl-filter .form-group {
		margin: 0;
	}
	.wanl-filter label {
		margin-right: 8px;
		color: var(--wanl-muted);
		font-weight: 600;
	}
	.wanl-filter .form-control {
		min-width: 240px;
		border-radius: 10px;
	}
	.wanl-filter .btn {
		border-radius: 10px;
	}
	.wanl-quick-range {
		display: flex;
		align-items: center;
		gap: 8px;
		flex-wrap: wrap;
	}
	.wanl-quick-range .quick-label {
		color: var(--wanl-muted);
		font-weight: 600;
	}
	.wanl-quick-range .btn-range {
		background: #fff;
		color: var(--wanl-strong);
		border: 1px solid var(--wanl-border);
		border-radius: 10px;
		padding: 6px 10px;
		transition: all 0.15s ease;
	}
	.wanl-quick-range .btn-range:hover {
		color: #0284c7;
		border-color: rgba(14, 165, 233, 0.5);
		box-shadow: 0 8px 18px -14px rgba(14, 165, 233, 0.6);
	}
	.wanl-quick-range .btn-range.active {
		background: var(--wanl-primary-soft);
		color: #0284c7;
		border-color: rgba(14, 165, 233, 0.6);
		box-shadow: 0 10px 22px -16px rgba(14, 165, 233, 0.65);
	}
	/* 结算状态筛选Tab */
	.wanl-state-tabs {
		display: flex;
		gap: 8px;
		margin-bottom: 14px;
		flex-wrap: wrap;
	}
	.wanl-state-tabs .state-tab {
		padding: 8px 16px;
		border-radius: 10px;
		border: 1px solid var(--wanl-border);
		background: #fff;
		color: var(--wanl-muted);
		font-weight: 600;
		font-size: 13px;
		cursor: pointer;
		transition: all 0.2s ease;
	}
	.wanl-state-tabs .state-tab:hover {
		border-color: var(--wanl-primary);
		color: var(--wanl-primary);
	}
	.wanl-state-tabs .state-tab.active {
		background: var(--wanl-primary);
		color: #fff;
		border-color: var(--wanl-primary);
	}
	.wanl-state-tabs .state-tab .count {
		display: inline-block;
		min-width: 20px;
		padding: 2px 6px;
		border-radius: 10px;
		background: rgba(0,0,0,0.1);
		font-size: 11px;
		margin-left: 4px;
	}
	.wanl-state-tabs .state-tab.active .count {
		background: rgba(255,255,255,0.3);
	}
	/* 结算状态标签样式 */
	.wanl-settlement-state {
		display: inline-flex;
		align-items: center;
		gap: 4px;
		padding: 4px 10px;
		border-radius: 6px;
		font-size: 12px;
		font-weight: 600;
	}
	.wanl-settlement-state.state-pending {
		background: #fef3c7;
		color: #92400e;
	}
	.wanl-settlement-state.state-success {
		background: #d1fae5;
		color: #065f46;
	}
	.wanl-settlement-state.state-processing {
		background: #dbeafe;
		color: #1e40af;
	}
	.wanl-settlement-state.state-failed {
		background: #fee2e2;
		color: #991b1b;
	}
	.wanl-settlement-state.state-none {
		background: #f3f4f6;
		color: #6b7280;
	}
	.wanl-table-wrap {
		background: var(--wanl-surface);
		border: 1px solid var(--wanl-border);
		border-radius: 16px;
		box-shadow: var(--wanl-shadow);
		width: 100%;
		overflow: hidden;
	}
	.wanl-table-head {
		display: flex;
		align-items: center;
		justify-content: space-between;
		gap: 12px;
		padding: 10px 14px;
		border-bottom: 1px solid var(--wanl-border);
	}
	.wanl-table-head .title {
		font-weight: 700;
		color: var(--wanl-strong);
		margin: 0;
	}
	.wanl-table-actions {
		display: flex;
		align-items: center;
		gap: 10px;
		margin-left: auto;
	}
	.wanl-table-actions .btn {
		border-radius: 10px;
	}
	.wanl-search {
		position: relative;
		width: 200px;
	}
	.wanl-search .wanl-search-input {
		width: 100%;
		height: 34px;
		border: 1px solid var(--wanl-border);
		border-radius: 999px;
		padding: 7px 38px 7px 12px;
		font-size: 13px;
		color: var(--wanl-strong);
		background: #fff;
		transition: border-color 0.2s ease, box-shadow 0.2s ease;
	}
	.wanl-search .wanl-search-input:focus {
		outline: none;
		border-color: var(--wanl-primary);
		box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.15);
	}
	.wanl-search .wanl-search-btn {
		position: absolute;
		top: 4px;
		right: 4px;
		bottom: 4px;
		border: none;
		border-radius: 999px;
		background: var(--wanl-primary);
		color: #fff;
		width: 32px;
		display: inline-flex;
		align-items: center;
		justify-content: center;
		transition: background 0.2s ease, box-shadow 0.2s ease;
	}
	.wanl-search .wanl-search-btn:hover {
		background: #0284c7;
		box-shadow: 0 10px 22px -16px rgba(14, 165, 233, 0.6);
	}
	.wanl-table-wrap .fixed-table-toolbar {
		display: none !important;
	}
	/* 表格布局 */
	.wanl-data-table {
		width: 100%;
		border-collapse: collapse;
		table-layout: fixed;
	}
	.wanl-data-table th,
	.wanl-data-table td {
		padding: 12px 16px;
		text-align: left;
		border-bottom: 1px solid var(--wanl-border);
		vertical-align: middle;
	}
	.wanl-data-table thead th {
		color: var(--wanl-muted);
		font-weight: 700;
		font-size: 12px;
		text-transform: uppercase;
		letter-spacing: 0.03em;
		background: #fafafa;
	}
	.wanl-data-table tbody tr:hover {
		background: #f8fafc;
	}
	.wanl-data-table tbody tr:last-child td {
		border-bottom: none;
	}
	/* 列宽 */
	.wanl-data-table .col-product { width: 20%; }
	.wanl-data-table .col-code { width: 18%; }
	.wanl-data-table .col-amount { width: 8%; }
	.wanl-data-table .col-settlement { width: 10%; }
	.wanl-data-table .col-method { width: 8%; }
	.wanl-data-table .col-user { width: 10%; }
	.wanl-data-table .col-time { width: 14%; }
	.wanl-data-table .col-action { width: 12%; }
	.wanl-product-inline {
		display: flex;
		align-items: center;
		gap: 10px;
	}
	.wanl-product-inline .thumb {
		width: 64px;
		height: 64px;
		border-radius: 10px;
		overflow: hidden;
		background: #e5e7eb;
		flex-shrink: 0;
	}
	.wanl-product-inline img {
		width: 100%;
		height: 100%;
		object-fit: cover;
	}
	.wanl-product-inline .title {
		font-weight: 700;
		color: var(--wanl-strong);
		margin-bottom: 2px;
	}
	.wanl-product-inline .desc {
		color: var(--wanl-muted);
		font-size: 12px;
		margin: 0;
	}
	.wanl-pill {
		display: inline-flex;
		align-items: center;
		gap: 6px;
		border-radius: 999px;
		padding: 6px 10px;
		font-weight: 700;
		font-size: 12px;
		background: var(--wanl-primary-soft);
		color: #0369a1;
	}
	.wanl-pill.green {
		background: rgba(34, 197, 94, 0.12);
		color: #15803d;
	}
	.wanl-pill.purple {
		background: rgba(99, 102, 241, 0.12);
		color: #4338ca;
	}
	.wanl-amount {
		font-weight: 800;
		color: var(--wanl-strong);
	}
	.wanl-time {
		color: var(--wanl-muted);
		font-size: 12px;
		display: inline-flex;
		align-items: center;
		gap: 6px;
	}
	.btn-ghost {
		background: #0f172a;
		color: #fff !important;
		border: none;
		border-radius: 10px;
		padding: 6px 12px;
		box-shadow: 0 10px 26px -18px rgba(15, 23, 42, 0.6);
	}
	.template-empty {
		text-align: center;
		color: var(--wanl-muted);
		padding: 20px 10px;
	}
</style>
<div class="panel panel-default panel-intro">
	<div class="panel-heading">
		<div class="wanl-head">
			<div>
				<p class="wanl-kicker">Verification board</p>
				<h3 class="wanl-title">核销记录</h3>
				<p class="wanl-subtitle">查看核销趋势、筛选时间范围并快速跳转详情</p>
			</div>
		</div>
	</div>
	<div class="panel-body">
		<div class="wanl-stat-grid">
			<div class="wanl-stat-card">
				<span class="icon" style="background: linear-gradient(135deg,#0ea5e9,#38bdf8);"><i class="fa fa-bolt"></i></span>
				<div class="meta">
					<span class="value" data-field="today_count">{$stats.today_count|default='0'}</span>
					<span class="label">今日核销数</span>
				</div>
			</div>
			<div class="wanl-stat-card">
				<span class="icon" style="background: linear-gradient(135deg,#a855f7,#6366f1);"><i class="fa fa-cny"></i></span>
				<div class="meta">
					<span class="value" data-field="today_amount">{$stats.today_amount|default='0.00'}</span>
					<span class="label">今日核销金额</span>
				</div>
			</div>
			<div class="wanl-stat-card">
				<span class="icon" style="background: linear-gradient(135deg,#22c55e,#16a34a);"><i class="fa fa-calendar"></i></span>
				<div class="meta">
					<span class="value" data-field="month_count">{$stats.month_count|default='0'}</span>
					<span class="label">本月核销数</span>
				</div>
			</div>
			<div class="wanl-stat-card">
				<span class="icon" style="background: linear-gradient(135deg,#f97316,#f59e0b);"><i class="fa fa-line-chart"></i></span>
				<div class="meta">
					<span class="value" data-field="month_amount">{$stats.month_amount|default='0.00'}</span>
					<span class="label">本月核销金额</span>
				</div>
			</div>
		</div>

		<div class="wanl-filter">
			<form class="form-inline" role="form">
				<div class="form-group">
					<label class="control-label">核销时间</label>
					<input type="text"
						   name="createtime"
						   class="form-control datetimerange"
						   placeholder="选择时间范围"
						   data-start-date="{:date('Y-m-01 00:00:00')}"
						   data-end-date="{:date('Y-m-t 23:59:59')}"
						   data-locale-format="YYYY-MM-DD HH:mm:ss"
						   value="{:date('Y-m-01 00:00:00')} - {:date('Y-m-t 23:59:59')}">
				</div>
				<div class="wanl-quick-range" aria-label="快捷时间选择">
					<span class="quick-label">快捷</span>
					<button type="button" class="btn btn-range" data-range="today">今日</button>
					<button type="button" class="btn btn-range" data-range="recent7">近7天</button>
					<button type="button" class="btn btn-range" data-range="recent30">近30天</button>
					<button type="button" class="btn btn-range" data-range="month">本月</button>
					<button type="button" class="btn btn-range" data-range="lastMonth">上月</button>
				</div>
				<button type="button" class="btn btn-primary btn-filter"><i class="fa fa-search"></i> 查询</button>
				<button type="button" class="btn btn-default btn-reset"><i class="fa fa-refresh"></i> 重置</button>
			</form>
		</div>

		<!-- 结算状态筛选Tab -->
		<div class="wanl-state-tabs" id="settlement-state-tabs">
			<button type="button" class="state-tab active" data-state="all">
				<i class="fa fa-list"></i> 全部
			</button>
			<button type="button" class="state-tab" data-state="2">
				<i class="fa fa-check-circle"></i> 已到账
			</button>
			<button type="button" class="state-tab" data-state="1">
				<i class="fa fa-clock-o"></i> 待结算
			</button>
			<button type="button" class="state-tab" data-state="3">
				<i class="fa fa-spinner"></i> 打款中
			</button>
			<button type="button" class="state-tab" data-state="4">
				<i class="fa fa-times-circle"></i> 打款失败
			</button>
		</div>

		<div class="wanl-table-wrap widget-body no-padding">
			<div class="wanl-table-head">
				<h4 class="title">核销记录列表</h4>
				<div class="wanl-table-actions">
					<a href="javascript:;" class="btn btn-default btn-refresh" title="{:__('Refresh')}"><i class="fa fa-refresh"></i> 刷新</a>
					<div class="wanl-search">
						<input type="text" class="wanl-search-input" placeholder="搜索商品/核销码/用户">
						<button type="button" class="wanl-search-btn"><i class="fa fa-search"></i></button>
					</div>
				</div>
			</div>
			<table class="wanl-data-table">
				<thead>
					<tr>
						<th class="col-product">商品</th>
						<th class="col-code">核销码</th>
						<th class="col-amount">金额</th>
						<th class="col-settlement">结算状态</th>
						<th class="col-method">核销方式</th>
						<th class="col-user">用户</th>
						<th class="col-time">时间</th>
						<th class="col-action">操作</th>
					</tr>
				</thead>
				<tbody id="data-list"></tbody>
			</table>
			<table id="table" data-show-export="false" data-show-toggle="false" data-show-columns="false" class="table" width="100%" style="display:none;"></table>
		</div>
	</div>
</div>
<script type="text/html" id="itemtpl">
	<% var goods = item.voucher && item.voucher.goods ? item.voucher.goods : {}; %>
	<%
		// 结算状态样式映射
		var settlementStateClass = 'state-none';
		var settlementStateIcon = 'fa-question-circle';
		if (item.settlement && item.settlement.state) {
			switch(item.settlement.state) {
				case '1': settlementStateClass = 'state-pending'; settlementStateIcon = 'fa-clock-o'; break;
				case '2': settlementStateClass = 'state-success'; settlementStateIcon = 'fa-check-circle'; break;
				case '3': settlementStateClass = 'state-processing'; settlementStateIcon = 'fa-spinner fa-spin'; break;
				case '4': settlementStateClass = 'state-failed'; settlementStateIcon = 'fa-times-circle'; break;
			}
		}
	%>
	<tr>
		<td>
			<div class="wanl-product-inline">
				<div class="thumb">
					<img src="<%= item.product_image ? cdnurl(item.product_image) : (goods.image ? cdnurl(goods.image) : '') %>" alt="<%= item.shop_goods_title || (item.voucher ? (item.voucher.goods_title || '') : '') %>">
				</div>
				<div>
					<div class="title"><%= item.shop_goods_title || (item.voucher ? (item.voucher.goods_title || '-') : '-') %></div>
					<p class="desc"><i class="fa fa-building-o"></i> <%= item.shop_name || '-' %></p>
				</div>
			</div>
		</td>
		<td>
			<span class="wanl-pill purple"><i class="fa fa-key"></i> <%= item.voucher_no || (item.voucher ? item.voucher.voucher_no : '') %></span>
		</td>
		<td>
			<span class="wanl-amount">￥<%= item.supply_price || '0.00' %></span>
		</td>
		<td>
			<span class="wanl-settlement-state <%= settlementStateClass %>">
				<i class="fa <%= settlementStateIcon %>"></i>
				<%= item.settlement_state_text || '未生成' %>
			</span>
		</td>
		<td>
			<span class="wanl-pill"><i class="fa fa-qrcode"></i> <%= item.verify_method_text || '-' %></span>
		</td>
		<td>
			<span class="wanl-pill green">
				<i class="fa fa-user"></i>
				<a href="javascript:;" class="searchit" data-field="user.nickname" data-value="<%= item.user ? item.user.nickname : '' %>"><%= item.user ? item.user.nickname : '-' %></a>
			</span>
		</td>
		<td>
			<span class="wanl-time"><i class="fa fa-clock-o"></i> <%= item.createtime ? Moment(item.createtime*1000).format("YYYY-MM-DD HH:mm:ss") : '-' %></span>
		</td>
		<td>
			<a href="javascript:;" class="btn btn-xs btn-ghost detail" data-id="<%=item.id%>">查看详情</a>
		</td>
	</tr>
</script>
