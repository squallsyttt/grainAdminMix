<style type="text/css">
    [v-cloak] { display: none }

    .invite-stat-container {
        padding: 0;
    }

    /* 搜索区域 */
    .search-section {
        background: #fff;
        border-radius: 4px;
        padding: 15px 20px;
        margin-bottom: 15px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .search-section .search-input {
        width: 300px;
        height: 34px;
        border: 1px solid #dcdfe6;
        border-radius: 4px;
        padding: 0 12px;
        font-size: 13px;
    }

    .search-section .search-input:focus {
        border-color: #3c8dbc;
        outline: none;
    }

    .search-section .btn-search {
        height: 34px;
        padding: 0 20px;
        background: #3c8dbc;
        border: none;
        color: #fff;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
    }

    .search-section .btn-search:hover {
        background: #367fa9;
    }

    /* 表格容器 */
    .table-section {
        background: #fff;
        border-radius: 4px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        margin-bottom: 15px;
    }

    .table-header {
        padding: 12px 20px;
        border-bottom: 1px solid #f0f0f0;
        font-size: 14px;
        font-weight: 600;
        color: #333;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .table-header .total-info {
        font-size: 13px;
        font-weight: normal;
        color: #999;
    }

    /* 数据表格 */
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th,
    .data-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #f5f5f5;
        font-size: 13px;
    }

    .data-table th {
        background: #fafafa;
        color: #666;
        font-weight: 500;
        white-space: nowrap;
    }

    .data-table tr:hover td {
        background: #f9fbfc;
    }

    .data-table tr.selected td {
        background: #e6f7ff;
    }

    .data-table tr.expanded td {
        background: #e6f7ff;
        border-bottom: none;
    }

    /* 用户信息单元格 */
    .user-cell {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .user-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 14px;
        font-weight: 500;
        overflow: hidden;
        flex-shrink: 0;
    }

    .user-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .user-info .name {
        font-weight: 500;
        color: #333;
        margin-bottom: 2px;
    }

    .user-info .mobile {
        font-size: 12px;
        color: #999;
    }

    /* 邀请码 */
    .invite-code {
        font-family: 'SF Mono', 'Consolas', monospace;
        font-size: 13px;
        font-weight: 600;
        color: #3c8dbc;
        background: #f0f7fc;
        padding: 4px 10px;
        border-radius: 4px;
        letter-spacing: 0.5px;
    }

    /* 统计数字 */
    .stat-num {
        font-weight: 600;
        font-size: 15px;
    }

    .stat-num.users {
        color: #3c8dbc;
    }

    .stat-num.shops {
        color: #f59e0b;
    }

    .stat-num.zero {
        color: #ccc;
    }

    /* 标签 */
    .tag {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: 500;
    }

    .tag.salesman {
        background: #fef3c7;
        color: #92400e;
    }

    .tag.normal {
        background: #f3f4f6;
        color: #6b7280;
    }

    /* 操作按钮 */
    .btn-action {
        padding: 5px 12px;
        border: 1px solid #dcdfe6;
        border-radius: 4px;
        background: #fff;
        color: #606266;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-action:hover {
        border-color: #3c8dbc;
        color: #3c8dbc;
    }

    .btn-action.primary {
        background: #3c8dbc;
        border-color: #3c8dbc;
        color: #fff;
    }

    .btn-action.primary:hover {
        background: #367fa9;
    }

    /* 分页 */
    .pagination-wrapper {
        padding: 12px 20px;
        border-top: 1px solid #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .pagination-info {
        font-size: 13px;
        color: #666;
    }

    .pagination-btns {
        display: flex;
        gap: 6px;
    }

    .pagination-btn {
        padding: 6px 12px;
        border: 1px solid #dcdfe6;
        border-radius: 4px;
        background: #fff;
        color: #606266;
        font-size: 13px;
        cursor: pointer;
    }

    .pagination-btn:hover:not(:disabled) {
        border-color: #3c8dbc;
        color: #3c8dbc;
    }

    .pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* 手风琴展开行 */
    .expand-row td {
        padding: 0;
        background: #f8fafc;
        border-bottom: 2px solid #e6f7ff;
    }

    .expand-content {
        padding: 15px 20px;
    }

    .detail-tabs {
        display: flex;
        gap: 6px;
        margin-bottom: 12px;
    }

    .detail-tab {
        padding: 6px 14px;
        border-radius: 4px;
        font-size: 13px;
        cursor: pointer;
        background: #fff;
        color: #666;
        border: 1px solid #dcdfe6;
    }

    .detail-tab:hover {
        border-color: #3c8dbc;
        color: #3c8dbc;
    }

    .detail-tab.active {
        background: #3c8dbc;
        border-color: #3c8dbc;
        color: #fff;
    }

    .detail-body {
        background: #fff;
        border-radius: 4px;
        padding: 12px;
        max-height: 300px;
        overflow-y: auto;
    }

    /* 邀请列表项 */
    .invited-item {
        display: flex;
        align-items: center;
        padding: 10px 12px;
        border-radius: 4px;
        margin-bottom: 8px;
        background: #fafafa;
    }

    .invited-item:last-child {
        margin-bottom: 0;
    }

    .invited-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: linear-gradient(135deg, #a78bfa, #8b5cf6);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 12px;
        margin-right: 12px;
        overflow: hidden;
    }

    .invited-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .invited-info {
        flex: 1;
    }

    .invited-name {
        font-size: 13px;
        font-weight: 500;
        color: #333;
    }

    .invited-meta {
        font-size: 12px;
        color: #999;
        margin-top: 2px;
    }

    .invited-time {
        font-size: 12px;
        color: #999;
        text-align: right;
    }

    /* 店铺项 - 无头像版本 */
    .shop-item {
        display: flex;
        align-items: center;
        padding: 10px 12px;
        border-radius: 4px;
        margin-bottom: 8px;
        background: linear-gradient(135deg, #fffbeb, #fef3c7);
        border: 1px solid #fde68a;
    }

    .shop-info {
        flex: 1;
    }

    .shop-name {
        font-size: 13px;
        font-weight: 600;
        color: #333;
    }

    .shop-meta {
        font-size: 12px;
        color: #666;
        margin-top: 3px;
    }

    .shop-status {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 4px;
    }

    .status-badge {
        padding: 2px 8px;
        border-radius: 3px;
        font-size: 11px;
        background: #f3f4f6;
        color: #6b7280;
    }

    .status-badge.open {
        background: #dcfce7;
        color: #166534;
    }

    .status-badge.closed {
        background: #fee2e2;
        color: #991b1b;
    }

    .status-badge.verified {
        background: #dbeafe;
        color: #1e40af;
    }

    /* 空状态 */
    .empty-state {
        padding: 30px 20px;
        text-align: center;
        color: #999;
    }

    .empty-state i {
        font-size: 28px;
        color: #ddd;
        margin-bottom: 8px;
    }

    /* 加载状态 */
    .loading-overlay {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .loading-spinner {
        width: 24px;
        height: 24px;
        border: 3px solid #e2e8f0;
        border-top-color: #3c8dbc;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* 详情分页 */
    .detail-pagination {
        margin-top: 10px;
        text-align: center;
        padding-top: 10px;
        border-top: 1px solid #f0f0f0;
    }
</style>

<div id="invitestat-app" class="invite-stat-container" v-cloak>
    <!-- 搜索区域 -->
    <div class="search-section">
        <input
            type="text"
            class="search-input"
            v-model="keyword"
            placeholder="搜索用户昵称、手机号或邀请码..."
            @keyup.enter="searchInviters"
        >
        <button class="btn-search" @click="searchInviters" :disabled="loading">
            <i class="fa fa-search"></i> 搜索
        </button>
    </div>

    <!-- 邀请人表格 -->
    <div class="table-section">
        <div class="table-header">
            <span><i class="fa fa-users"></i> 邀请人列表</span>
            <span class="total-info">共 {{ inviterTotal }} 条记录</span>
        </div>

        <table class="data-table" v-if="!loading && inviters.length > 0">
            <thead>
                <tr>
                    <th style="width: 60px;">ID</th>
                    <th style="width: 200px;">用户信息</th>
                    <th style="width: 120px;">邀请码</th>
                    <th style="width: 100px;">邀请用户</th>
                    <th style="width: 100px;">邀请店铺</th>
                    <th style="width: 150px;">注册时间</th>
                    <th style="width: 100px;">操作</th>
                </tr>
            </thead>
            <tbody>
                <template v-for="inviter in inviters">
                    <!-- 数据行 -->
                    <tr
                        :key="'row-' + inviter.id"
                        :class="{ expanded: expandedId === inviter.id }"
                    >
                        <td>{{ inviter.id }}</td>
                        <td>
                            <div class="user-cell">
                                <div class="user-avatar">
                                    <img v-if="inviter.avatar" :src="inviter.avatar">
                                    <span v-else>{{ (inviter.nickname || 'U').charAt(0).toUpperCase() }}</span>
                                </div>
                                <div class="user-info">
                                    <div class="name">{{ inviter.nickname || '未设置' }}</div>
                                    <div class="mobile">{{ inviter.mobile || '未绑定手机' }}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="invite-code">{{ inviter.invite_code }}</span>
                        </td>
                        <td>
                            <span class="stat-num users" :class="{ zero: inviter.invited_user_count === 0 }">
                                {{ inviter.invited_user_count }}
                            </span>
                        </td>
                        <td>
                            <span class="stat-num shops" :class="{ zero: inviter.invited_shop_count === 0 }">
                                {{ inviter.invited_shop_count }}
                            </span>
                        </td>
                        <td>{{ inviter.createtime }}</td>
                        <td>
                            <button
                                class="btn-action"
                                :class="{ primary: expandedId === inviter.id }"
                                @click="toggleExpand(inviter)"
                            >
                                <i :class="expandedId === inviter.id ? 'fa fa-chevron-up' : 'fa fa-chevron-down'"></i>
                                {{ expandedId === inviter.id ? '收起' : '详情' }}
                            </button>
                        </td>
                    </tr>
                    <!-- 展开行（手风琴） -->
                    <tr v-if="expandedId === inviter.id" :key="'expand-' + inviter.id" class="expand-row">
                        <td colspan="7">
                            <div class="expand-content">
                                <div class="detail-tabs">
                                    <button
                                        class="detail-tab"
                                        :class="{ active: detailTab === 'users' }"
                                        @click="switchTab('users')"
                                    >
                                        <i class="fa fa-users"></i> 邀请用户 ({{ inviter.invited_user_count }})
                                    </button>
                                    <button
                                        class="detail-tab"
                                        :class="{ active: detailTab === 'shops' }"
                                        @click="switchTab('shops')"
                                    >
                                        <i class="fa fa-shopping-bag"></i> 邀请店铺 ({{ inviter.invited_shop_count }})
                                    </button>
                                </div>

                                <div class="detail-body">
                                    <!-- 邀请用户列表 -->
                                    <div v-show="detailTab === 'users'">
                                        <div class="loading-overlay" v-if="detailLoading">
                                            <div class="loading-spinner"></div>
                                        </div>

                                        <div v-else-if="invitedUsers.length > 0">
                                            <div v-for="user in invitedUsers" :key="user.id" class="invited-item">
                                                <div class="invited-avatar">
                                                    <img v-if="user.avatar" :src="user.avatar">
                                                    <span v-else>{{ (user.nickname || 'U').charAt(0).toUpperCase() }}</span>
                                                </div>
                                                <div class="invited-info">
                                                    <div class="invited-name">{{ user.nickname || '未设置昵称' }}</div>
                                                    <div class="invited-meta">
                                                        <span>{{ user.mobile || '未绑定手机' }}</span>
                                                        <span v-if="user.shop" style="margin-left: 10px; color: #f59e0b;">
                                                            <i class="fa fa-link"></i> 已绑定店铺: {{ user.shop.shopname }}
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="invited-time">
                                                    注册: {{ user.createtime }}
                                                </div>
                                            </div>

                                            <div class="detail-pagination" v-if="invitedUserPages > 1">
                                                <button class="btn-action" :disabled="invitedUserPage <= 1" @click="changeInvitedUserPage(invitedUserPage - 1)">上一页</button>
                                                <span style="margin: 0 10px; font-size: 12px; color: #999;">{{ invitedUserPage }} / {{ invitedUserPages }}</span>
                                                <button class="btn-action" :disabled="invitedUserPage >= invitedUserPages" @click="changeInvitedUserPage(invitedUserPage + 1)">下一页</button>
                                            </div>
                                        </div>

                                        <div class="empty-state" v-else>
                                            <i class="fa fa-user-o"></i>
                                            <p>暂无邀请用户</p>
                                        </div>
                                    </div>

                                    <!-- 邀请店铺列表 -->
                                    <div v-show="detailTab === 'shops'">
                                        <div class="loading-overlay" v-if="detailLoading">
                                            <div class="loading-spinner"></div>
                                        </div>

                                        <div v-else-if="invitedShops.length > 0">
                                            <div v-for="shop in invitedShops" :key="shop.id" class="shop-item">
                                                <div class="shop-info">
                                                    <div class="shop-name">
                                                        <i class="fa fa-shopping-bag" style="color: #f59e0b; margin-right: 6px;"></i>
                                                        {{ shop.shopname }}
                                                    </div>
                                                    <div class="shop-meta">
                                                        <span><i class="fa fa-map-marker"></i> {{ shop.city || '未设置' }}</span>
                                                        <span style="margin-left: 12px;" v-if="shop.user">
                                                            <i class="fa fa-user"></i> {{ shop.user.nickname }} / {{ shop.user.mobile }}
                                                        </span>
                                                    </div>
                                                    <div class="shop-meta" v-if="shop.invite_bind_time">
                                                        <i class="fa fa-clock-o"></i> 邀请绑定: {{ shop.invite_bind_time }}
                                                    </div>
                                                </div>
                                                <div class="shop-status">
                                                    <span class="status-badge" :class="{ open: shop.state === '1', closed: shop.state !== '1' }">
                                                        {{ shop.state_text }}
                                                    </span>
                                                    <span class="status-badge" :class="{ verified: shop.verify === '3' }">
                                                        {{ shop.verify_text }}
                                                    </span>
                                                </div>
                                            </div>

                                            <div class="detail-pagination" v-if="invitedShopPages > 1">
                                                <button class="btn-action" :disabled="invitedShopPage <= 1" @click="changeInvitedShopPage(invitedShopPage - 1)">上一页</button>
                                                <span style="margin: 0 10px; font-size: 12px; color: #999;">{{ invitedShopPage }} / {{ invitedShopPages }}</span>
                                                <button class="btn-action" :disabled="invitedShopPage >= invitedShopPages" @click="changeInvitedShopPage(invitedShopPage + 1)">下一页</button>
                                            </div>
                                        </div>

                                        <div class="empty-state" v-else>
                                            <i class="fa fa-shopping-bag"></i>
                                            <p>暂无邀请店铺</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                </template>
            </tbody>
        </table>

        <!-- 加载状态 -->
        <div class="loading-overlay" v-if="loading">
            <div class="loading-spinner"></div>
        </div>

        <!-- 空状态 -->
        <div class="empty-state" v-if="!loading && inviters.length === 0">
            <i class="fa fa-inbox"></i>
            <p>暂无邀请数据</p>
        </div>

        <!-- 分页 -->
        <div class="pagination-wrapper" v-if="inviterTotal > 0">
            <div class="pagination-info">
                第 {{ inviterPage }} / {{ inviterPages }} 页
            </div>
            <div class="pagination-btns">
                <button class="pagination-btn" :disabled="inviterPage <= 1" @click="changeInviterPage(inviterPage - 1)">
                    <i class="fa fa-chevron-left"></i> 上一页
                </button>
                <button class="pagination-btn" :disabled="inviterPage >= inviterPages" @click="changeInviterPage(inviterPage + 1)">
                    下一页 <i class="fa fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>
